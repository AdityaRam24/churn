trigger:
  branches:
    include:
      - main

pool:
  name: Default  # your self‑hosted agent

variables:
  imageName: customer-churn-prediction
  containerRegistry: docker-hub-connection
  dockerfilePath: Dockerfile
  buildContext: .
  # dynamic tag: branch-buildID, plus always push “latest”
  imageTag: '$(Build.SourceBranchName)-$(Build.BuildId)'

steps:
  - checkout: self

  - task: Docker@2
    displayName: Build + Push Docker Image
    timeoutInMinutes: 20
    inputs:
      command: buildAndPush
      containerRegistry: $(containerRegistry)
      repository: $(imageName)
      dockerfile: $(dockerfilePath)
      buildContext: $(buildContext)
      tags: |
        $(imageTag)
        latest
      # enable registry-backed build cache
      cacheFrom: |
        type=registry,ref=$(containerRegistry)/$(imageName):cache
      cacheTo: |
        type=registry,ref=$(containerRegistry)/$(imageName):cache,mode=max
