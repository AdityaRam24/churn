trigger:
  branches:
    include:
      - main

pool:
  name: Default

variables:
  imageName: customer-churn-prediction
  containerRegistry: docker-hub-connection
  # <-- point here to the Dockerfile location
  dockerfilePath: CustomerChurn/Customer-Churn-Prediction/Dockerfile
  # <-- build context is the folder containing your source
  buildContext: CustomerChurn/Customer-Churn-Prediction
  imageTag: '$(Build.SourceBranchName)-$(Build.BuildId)'

steps:
  - checkout: self

  - task: Docker@2
    displayName: Build + Push Docker Image
    timeoutInMinutes: 20
    inputs:
      command: buildAndPush
      containerRegistry: $(containerRegistry)
      repository: $(imageName)
      dockerfile: $(dockerfilePath)
      buildContext: $(buildContext)
      tags: |
        $(imageTag)
        latest
      cacheFrom: |
        type=registry,ref=$(containerRegistry)/$(imageName):cache
      cacheTo: |
        type=registry,ref=$(containerRegistry)/$(imageName):cache,mode=max
